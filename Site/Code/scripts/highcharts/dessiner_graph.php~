<?php require_once('ConnexionBD.php'); ?>

<script type='text/javascript' src='jquery.min.js'></script>
<script type="text/javascript" src="Highcharts/js/highcharts.js" ></script>

<?php
Function generer_Graphique($dateDeb , $dateFin , $sondes, $conteneur){
	global $connexion;
	$tab = array();

	foreach( $sondes as $val){
		 $tab[$val] = array();

		 $stmt = $connexion->prepare("Select Date,Valeur from Temperature where Date >= :date_d  and Date <= :date_f and Sonde_id = :id_Sonde ");
		 $stmt -> bindParam(':date_d' , $dateDeb);
		 $stmt -> bindParam(':date_f' , $dateFin);
		 $stmt -> bindParam(':id_Sonde' , $val);
		 $stmt -> execute();


		 foreach( $stmt as $requete ){
		 	  $tab[$val][] = $requete[0];
		 	  $tab[$val][] = $requete[1];
		}
	}

	$date_explosee = explode("-", $dateDeb); 

	$jourDeb = $date_explosee[2];
	$moisDeb = $date_explosee[1];
	$anneeDeb = $date_explosee[0];

	$date_explosee = explode("-", $dateFin);

	$jourFin = $date_explosee[2];
	$moisFin = $date_explosee[1];
	$anneeFin = $date_explosee[0];


?>

<script>
$(function(){
        $('<?php echo "#".$conteneur; ?>').highcharts({
	    chart: {
	    zoomType: 'x'
	    },
            title: {
                text: 'Temperatures des sondes du ' + dateDeb.getDate() + ' / ' + (dateDeb.getMonth()) + ' / ' + dateDeb.getFullYear() + ' au ' + dateFin.getDate() + ' / ' + (dateFin.getMonth()) + ' / ' + dateFin.getFullYear() // affiche de la date de debut et de fin
            },
	    xAxis: {
                type: 'datetime',
	    },
            yAxis: {
                title: {
                    text: 'Temperatures'
                }
            },
            plotOptions: {
                line: {
                    fillColor: {
                        linearGradient: { x1: 0, y1: 0, x2: 0, y2: 1},
                        stops: [
                            [0, Highcharts.getOptions().colors[0]],
                            [1, Highcharts.Color(Highcharts.getOptions().colors[0]).setOpacity(0).get('rgba')]
                        ]
                    },
                    lineWidth: 1,
                    marker: {
                        enabled: false
                    },
                    shadow: false,
                    states: {
                        hover: {
                            lineWidth: 1
                        }
                    },
                    threshold: null
                }
            },
            series: [
		<?php

		foreach( $tab as $s => $val2){
 			 $cpt = 0;
		 ?>
		{
                type: 'line',
                name: <?php echo "'Sonde " . $s ."',\n"; ?>
                data: [ 
		<?php
			 foreach( $val2 as $v ){
			 	  $cpt++;
				  if( $cpt%2 ==1 ){
				      if( $cpt > 1 )
				      	  echo ",\n";
				  $separation = explode(" ", $v); 
				  $date  = explode("-", $separation[0]);
				  $heure = explode(":", $separation[1]);

			 	      echo "[Date.UTC(". $date[0] . ",". $date[1] . ",". $date[2] . ",". $heure[0] . ",". $heure[1] . "),";
				  }
				  else
				      echo $v . "]";
			}
		echo "],\n";
		echo "},\n";
		}
		?>
	    ]
        });
    });

</script>

<?php
}
?>